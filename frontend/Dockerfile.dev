FROM node:20-alpine

WORKDIR /app

# Install dependencies
COPY package.json package-lock.json* ./
RUN npm ci

# Copy source code
COPY . .

# Expose port
EXPOSE 3000

# Create entrypoint script to ensure dependencies are installed
RUN echo '#!/bin/sh' > /entrypoint.sh && \
  echo 'if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/next" ]; then' >> /entrypoint.sh && \
  echo '  echo "Installing dependencies..."' >> /entrypoint.sh && \
  echo '  npm ci' >> /entrypoint.sh && \
  echo 'fi' >> /entrypoint.sh && \
  echo 'exec "$@"' >> /entrypoint.sh && \
  chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]

# Start development server with hot reload
CMD ["npm", "run", "dev"]

